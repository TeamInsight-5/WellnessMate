<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>LifeCare - ì‹¬ë¦¬ì¼€ì–´</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/footer.css}">
    <link rel="stylesheet" th:href="@{/css/mental-care.css}">
    <script defer th:src="@{/js/mental-care.js}"></script>
    <script th:src="@{'//dapi.kakao.com/v2/maps/sdk.js?appkey=' + ${kakaoAppKey} + '&libraries=services,clusterer&autoload=false'}"></script>
</head>
<body>
<div th:replace="~{mainPage:: header}"></div>

<main class="mc-container">

    <!-- Hero -->
    <section class="mc-hero">
        <img src="/img/mental-hero.jpg" alt="ì •ì‹ ê±´ê°• ìƒë‹´ ë°°ë„ˆ" />
        <div class="mc-hero__inner">
            <div>
                <div class="mc-hero__icon">ğŸ’™</div>
                <h1 class="mc-hero__title">ì‹¬ë¦¬ì¼€ì–´</h1>
                <p class="mc-hero__desc">AI ìƒë‹´ë¶€í„° ìš°ìš¸ì¦ ìê°€ì§„ë‹¨ê¹Œì§€, ë§ˆìŒ ê±´ê°•ì„ ìœ„í•œ ì¢…í•© ì¼€ì–´</p>
            </div>
        </div>
    </section>

    <!-- Tabs (ë³€ê²½ ì—†ìŒ) -->
    <section class="mc-tabs">
        <div class="mc-tablist" role="tablist" aria-label="ì‹¬ë¦¬ì¼€ì–´ íƒ­">
            <button class="mc-tab" role="tab" aria-selected="true" aria-controls="tab-chat" id="tabbtn-chat">ğŸ¤– AI ìƒë‹´</button>
            <button class="mc-tab" role="tab" aria-selected="false" aria-controls="tab-cesd" id="tabbtn-cesd">ğŸ§  CES-D ìš°ìš¸ì¦ ì§„ë‹¨</button>
            <button class="mc-tab" role="tab" aria-selected="false" aria-controls="tab-emergency" id="tabbtn-emergency">âš¡ ìœ„ê¸°ëŒ€ì‘</button>
        </div>

        <!-- â€¦ (ì¤‘ëµ: ê¸°ì¡´ ì±„íŒ…/ì§„ë‹¨/ìœ„ê¸°ëŒ€ì‘ ì„¹ì…˜ ê·¸ëŒ€ë¡œ ìœ ì§€) â€¦ -->

    </section>

    <!-- ë³‘ì› ì°¾ê¸°: ì£¼ì†Œ ê²€ìƒ‰ + ë‚´ ìœ„ì¹˜ ì§€ë„/ê²€ìƒ‰ -->
    <section style="margin-top:28px;">
        <div class="mc-card">
            <div class="mc-toolbar" style="background:linear-gradient(90deg,#2563eb,#1d4ed8); color:#fff; padding:18px;">
                <div>
                    <div style="font-size:18px; font-weight:700;">ì •ì‹ ê±´ê°• ì˜ë£Œê¸°ê´€ ì°¾ê¸°</div>
                    <div style="opacity:.9; font-size:13px;">ë‚´ ìœ„ì¹˜ ê¸°ì¤€ ì§€ë„ì™€ ì£¼ë³€ ê²€ìƒ‰ Â· ì£¼ì†Œë¡œ ì¬ê²€ìƒ‰ ê°€ëŠ¥</div>
                </div>
                <div class="mc-search-row">
                    <input id="mc-hosp-addr" class="mc-input" type="text" placeholder="ì˜ˆ: ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123" />
                    <button id="mc-hosp-searchBtn" class="mc-btn mc-btn--outline" style="color:#fff; border-color:#fff;">ì£¼ì†Œë¡œ ê²€ìƒ‰</button>
                    <button id="mc-hosp-myBtn" class="mc-btn mc-btn--primary">ë‚´ ìœ„ì¹˜ë¡œ ê²€ìƒ‰</button>
                </div>
            </div>

            <!-- ì§€ë„ -->
            <div class="mc-map" id="mc-map"></div>

            <!-- ê²€ìƒ‰ ìƒíƒœ/ê²°ê³¼ -->
            <div class="mc-card--p6">
                <div id="mc-hosp-status" class="mc-muted" style="margin-bottom:10px;"></div>
                <div id="mc-hosp-result" class="mc-grid" style="grid-template-columns: repeat(auto-fit,minmax(280px,1fr));"></div>
            </div>
        </div>
    </section>
</main>

<div th:replace="~{mainPage:: footer}"></div>

<script>
    // CSRF
    const CSRF_TOKEN = document.querySelector('meta[name="_csrf"]')?.getAttribute('content') || '';
    const CSRF_HEADER = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content') || 'X-CSRF-TOKEN';

    /* íƒ­ */
    const tabs = [
      {btn: 'tabbtn-chat', panel:'tab-chat'},
      {btn: 'tabbtn-cesd', panel:'tab-cesd'},
      {btn: 'tabbtn-emergency', panel:'tab-emergency'}
    ];
    tabs.forEach(t=>{
      const b=document.getElementById(t.btn), p=document.getElementById(t.panel);
      b.addEventListener('click', ()=>{
        document.querySelectorAll('.mc-tab').forEach(el=>el.setAttribute('aria-selected','false'));
        document.querySelectorAll('.mc-tabpanel').forEach(el=>el.classList.remove('is-active'));
        b.setAttribute('aria-selected','true'); p.classList.add('is-active');
      });
    });

    /* === ì±„íŒ… === */
    const chatList = document.getElementById('mc-chat-list');
    const chatInput = document.getElementById('mc-chat-input');
    const chatSend = document.getElementById('mc-chat-send');

    function addMsg(type, content, suggestions){
      const row = document.createElement('div');
      row.className = 'mc-chat__row';
      const bubble = document.createElement('div');
      bubble.className = 'mc-chat__bubble ' + (type==='user' ? 'mc-chat__bubble--user' : 'mc-chat__bubble--bot');
      bubble.textContent = content;
      const time = document.createElement('div');
      time.className = 'mc-chat__time'; time.textContent = new Date().toLocaleTimeString();
      bubble.appendChild(document.createElement('br'));
      bubble.appendChild(time);
      row.appendChild(bubble);
      chatList.appendChild(row);

      if(Array.isArray(suggestions) && suggestions.length){
        const sugg = document.createElement('div');
        sugg.className = 'mc-chat__suggest';
        suggestions.forEach(s=>{
          const btn = document.createElement('button');
          btn.className = 'mc-btn mc-btn--outline'; btn.textContent = s;
          btn.addEventListener('click', ()=> sendMessage(s));
          sugg.appendChild(btn);
        });
        chatList.appendChild(sugg);
      }
      chatList.scrollTop = chatList.scrollHeight;
    }

    async function sendMessage(text){
      if(!text || !text.trim()) return;
      addMsg('user', text);
      chatInput.value = '';

      // typing...
      const typing = document.createElement('div');
      typing.className = 'mc-chat__row mc-typing'; typing.id = 'mc-typing';
      typing.innerHTML = '<i></i><i></i><i></i>';
      chatList.appendChild(typing);
      chatList.scrollTop = chatList.scrollHeight;

      try{
        const res = await fetch('/api/mental-care/ai-chat', {
          method:'POST',
          headers:{ 'Content-Type':'application/json', [CSRF_HEADER]: CSRF_TOKEN },
          body: JSON.stringify({ message: text, sessionId: 'web-'+Date.now() })
        });
        const data = await res.json();
        document.getElementById('mc-typing')?.remove();
        const content = data.response || 'ë‹µë³€ ìƒì„±ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        let suggestions = [];
        if(/ìŠ¤íŠ¸ë ˆìŠ¤|ì••ë°•/.test(text)) suggestions = ['ì—…ë¬´ê°€ í˜ë“¤ì–´ìš”','ì¸ê°„ê´€ê³„ê°€ í˜ë“¤ì–´ìš”','ëˆ ê±±ì •ì´ ë§ì•„ìš”','ê±´ê°•ì´ ê±±ì •ë¼ìš”'];
        if(/ì |ìˆ˜ë©´|ë¶ˆë©´/.test(text)) suggestions = ['2-3ì‹œê°„ë°–ì— ëª» ììš”','ìƒˆë²½ì— ìì£¼ ê¹¨ìš”','ì•…ëª½ì„ ê¿”ìš”','ì „ë¬¸ì˜ ìƒë‹´ ì›í•´ìš”'];
        if(/ìš°ìš¸|ìŠ¬í”„|ë¬´ê¸°ë ¥/.test(text)) suggestions = ['1-2ì£¼ ì •ë„ìš”','í•œ ë‹¬ ë„˜ê²Œìš”','ì£½ê³  ì‹¶ë‹¤ëŠ” ìƒê°ì´ ë“¤ì–´ìš”','ëˆ„êµ¬ì—ê²Œë„ ë§ ëª»í•´ìš”'];
        if(/ë¶ˆì•ˆ|ê±±ì •|ê³µí™©/.test(text)) suggestions = ['ì‚¬ëŒë“¤ ì•ì—ì„œ ë§í•  ë•Œ','ì‹œí—˜/ë°œí‘œ ì „ì—','ì´ìœ  ì—†ì´','ì‘ê¸‰ìƒí™© ê°™ì•„ìš”'];
        addMsg('bot', content, suggestions);
      }catch(e){
        document.getElementById('mc-typing')?.remove();
        addMsg('bot', 'ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ì´ˆê¸° í™˜ì˜ ë©”ì‹œì§€
    addMsg('bot', 'ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” LifeCare AI ì‹¬ë¦¬ìƒë‹´ì‚¬ì…ë‹ˆë‹¤. ğŸ˜Š\n\ní˜„ì¬ ì–´ë–¤ ë§ˆìŒì˜ ì–´ë ¤ì›€ì„ ê²ªê³  ê³„ì‹ ê°€ìš”? í¸ì•ˆí•˜ê²Œ ë§ì”€í•´ ì£¼ì„¸ìš”.', ['ìŠ¤íŠ¸ë ˆìŠ¤ê°€ ì‹¬í•´ìš”','ì ì´ ì•ˆ ì™€ìš”','ìš°ìš¸í•œ ê¸°ë¶„ì´ì—ìš”','ë¶ˆì•ˆí•´ìš”']);
    chatSend.addEventListener('click', ()=> sendMessage(chatInput.value));
    chatInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter'){ sendMessage(chatInput.value); } });

    /* === CES-D === */
    const cesdQuestions=[{id:'q1',text:'í‰ì†Œì—ëŠ” ì•„ë¬´ë ‡ì§€ë„ ì•Šë˜ ì¼ë“¤ì´ ê·€ì°®ê³  ì„±ê°€ì‹œê²Œ ëŠê»´ì¡Œë‹¤',rev:false},{id:'q2',text:'ë¨¹ê³  ì‹¶ì§€ ì•Šê³  ì‹ìš•ì´ ì—†ì—ˆë‹¤',rev:false},{id:'q3',text:'ê°€ì¡±ì´ë‚˜ ì¹œêµ¬ê°€ ë„ì™€ì£¼ì–´ë„ ìš¸ì í•œ ê¸°ë¶„ì„ ë–¨ì³ë²„ë¦´ ìˆ˜ ì—†ì—ˆë‹¤',rev:false},{id:'q4',text:'ë‹¤ë¥¸ ì‚¬ëŒë“¤ë§Œí¼ ëŠ¥ë ¥ì´ ìˆë‹¤ê³  ëŠê¼ˆë‹¤',rev:true},{id:'q5',text:'ë¬´ìŠ¨ ì¼ì„ í•˜ë“  ì •ì‹ ì„ ì§‘ì¤‘í•˜ê¸°ê°€ í˜ë“¤ì—ˆë‹¤',rev:false},{id:'q6',text:'ìš°ìš¸í–ˆë‹¤',rev:false},{id:'q7',text:'í•˜ëŠ” ì¼ë§ˆë‹¤ í˜ë“¤ê²Œ ëŠê»´ì¡Œë‹¤',rev:false},{id:'q8',text:'ë¯¸ë˜ì— ëŒ€í•˜ì—¬ í¬ë§ì ìœ¼ë¡œ ëŠê¼ˆë‹¤',rev:true},{id:'q9',text:'ë‚´ ì¸ìƒì€ ì‹¤íŒ¨ì‘ì´ë¼ëŠ” ìƒê°ì´ ë“¤ì—ˆë‹¤',rev:false},{id:'q10',text:'ë¬´ì„œì›€ì„ ëŠê¼ˆë‹¤',rev:false},{id:'q11',text:'ì ì„ ì„¤ì³¤ë‹¤ (ì ì„ ì˜ ì´ë£¨ì§€ ëª»í–ˆë‹¤)',rev:false},{id:'q12',text:'í–‰ë³µí–ˆë‹¤',rev:true},{id:'q13',text:'í‰ì†Œë³´ë‹¤ ë§ì„ ì ê²Œ í–ˆë‹¤',rev:false},{id:'q14',text:'ì„¸ìƒì— í™€ë¡œ ìˆëŠ” ë“¯í•œ ì™¸ë¡œì›€ì„ ëŠê¼ˆë‹¤',rev:false},{id:'q15',text:'ì‚¬ëŒë“¤ì´ ë‚˜ì—ê²Œ ì°¨ê°‘ê²Œ ëŒ€í•˜ëŠ” ê²ƒ ê°™ì•˜ë‹¤',rev:false},{id:'q16',text:'ìƒí™œì´ ì¦ê±°ì› ë‹¤',rev:true},{id:'q17',text:'ê°‘ìê¸° ìš¸ìŒì´ ë‚˜ì™”ë‹¤',rev:false},{id:'q18',text:'ìŠ¬í””ì„ ëŠê¼ˆë‹¤',rev:false},{id:'q19',text:'ì‚¬ëŒë“¤ì´ ë‚˜ë¥¼ ì‹«ì–´í•˜ëŠ” ê²ƒ ê°™ë‹¤ê³  ëŠê¼ˆë‹¤',rev:false},{id:'q20',text:'ë„ë¬´ì§€ ë­˜ í•´ë‚˜ê°ˆ ì—„ë‘ê°€ ë‚˜ì§€ ì•Šì•˜ë‹¤',rev:false}];
    const cesdOpts=[{v:0,label:'ê·¹íˆ ë“œë¬¼ê²Œ (1ì¼ ë¯¸ë§Œ)',desc:'ì „í˜€ ì—†ì—ˆë‹¤'},{v:1,label:'ê°€ë” (1-2ì¼)',desc:'ì¡°ê¸ˆ ìˆì—ˆë‹¤'},{v:2,label:'ì¢…ì¢… (3-4ì¼)',desc:'ìì£¼ ìˆì—ˆë‹¤'},{v:3,label:'ëŒ€ë¶€ë¶„ (5-7ì¼)',desc:'ê±°ì˜ ë§¤ì¼'}];
    const ans={}; let step=0;
    const qBox=document.getElementById('mc-cesd-question-box');
    const optBox=document.getElementById('mc-cesd-options');
    const stepLabel=document.getElementById('mc-cesd-step-label');
    const prog=document.getElementById('mc-cesd-progress');
    const prevBtn=document.getElementById('mc-cesd-prev');
    const nextBtn=document.getElementById('mc-cesd-next');
    const resultWrap=document.getElementById('mc-cesd-result');
    const badge=document.getElementById('mc-cesd-badge');
    const desc=document.getElementById('mc-cesd-desc');
    const scorebar=document.getElementById('mc-cesd-scorebar');
    const recoBox=document.getElementById('mc-cesd-reco');
    const resetBtn=document.getElementById('mc-cesd-reset');
    const saveBtn=document.getElementById('mc-cesd-save');

    function renderStep(){
      const q=cesdQuestions[step];
      stepLabel.textContent=(step+1)+'/'+cesdQuestions.length;
      prog.style.width=((step+1)/cesdQuestions.length*100)+'%';
      qBox.innerHTML='<div class="mc-muted" style="font-size:13px; margin-bottom:6px;">ë¬¸í•­ '+(step+1)+'</div><div style="font-size:16px; color:var(--mc-text);">'+q.text+'</div>';
      optBox.innerHTML='';
      cesdOpts.forEach(o=>{
        const row=document.createElement('label'); row.className='mc-radio-row';
        row.innerHTML=`<input type="radio" name="mc-ans" value="${o.v}" ${ans[q.id]===o.v?'checked':''} />
          <div><div style="font-weight:600; color:#111827;">${o.label}</div>
          <div class="mc-muted" style="font-size:12px;">${o.desc}</div></div>`;
        row.querySelector('input').addEventListener('change',e=>{ ans[q.id]=parseInt(e.target.value,10); });
        optBox.appendChild(row);
      });
      prevBtn.disabled=(step===0);
      nextBtn.textContent=(step===cesdQuestions.length-1)?'ê²°ê³¼ ë³´ê¸°':'ë‹¤ìŒ';
    }
    renderStep();

    function calcScore(){ let total=0; cesdQuestions.forEach(q=>{ const v=ans[q.id]; if(v!==undefined){ total+=q.rev?(3-v):v; } }); return total; }
    function toLevel(score){
      if(score<16) return {badge:'ì •ìƒ', color:'mc-badge--green', desc:'í˜„ì¬ ìš°ìš¸ ì¦ìƒì´ ê±°ì˜ ì—†ëŠ” ì •ìƒ ë²”ìœ„ì…ë‹ˆë‹¤.', reco:'ê·œì¹™ì ì¸ ìˆ˜ë©´/ìš´ë™, ìŠ¤íŠ¸ë ˆìŠ¤ ê´€ë¦¬ë¡œ í˜„ì¬ ìƒíƒœë¥¼ ìœ ì§€í•˜ì„¸ìš”.'};
      if(score<21) return {badge:'ê²½ë¯¸í•œ ìš°ìš¸', color:'mc-badge--yellow', desc:'ê²½ë¯¸í•œ ìš°ìš¸ ì¦ìƒì´ ìˆìŠµë‹ˆë‹¤.', reco:'ìƒí™œìŠµê´€ ê°œì„ ê³¼ ìŠ¤íŠ¸ë ˆìŠ¤ ê´€ë¦¬, í•„ìš” ì‹œ ìƒë‹´ì„ ê¶Œì¥í•©ë‹ˆë‹¤.'};
      if(score<25) return {badge:'ì¤‘ë“±ë„ ìš°ìš¸', color:'mc-badge--orange', desc:'ì¤‘ë“±ë„ì˜ ìš°ìš¸ ì¦ìƒì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.', reco:'ì „ë¬¸ì˜ ìƒë‹´ì„ ê¶Œì¥í•©ë‹ˆë‹¤.'};
      return {badge:'ì‹¬í•œ ìš°ìš¸', color:'mc-badge--red', desc:'ì‹¬í•œ ìš°ìš¸ ì¦ìƒìœ¼ë¡œ ì¦‰ì‹œ ì „ë¬¸ ì¹˜ë£Œê°€ í•„ìš”í•©ë‹ˆë‹¤.', reco:'ì§€ì²´ ì—†ì´ ì •ì‹ ê±´ê°•ì˜í•™ê³¼ ì§„ë£Œë¥¼ ë°›ìœ¼ì„¸ìš”.'};
    }

    nextBtn.addEventListener('click', async ()=>{
      const q=cesdQuestions[step];
      if(ans[q.id]===undefined){ alert('ì‘ë‹µì„ ì„ íƒí•´ ì£¼ì„¸ìš”.'); return; }
      if(step<cesdQuestions.length-1){ step++; renderStep(); }
      else{
        const scoresArr=cesdQuestions.map(q=> ans[q.id] ?? 0);
        try{
          const res=await fetch('/api/mental-care/cesd-assessment',{ method:'POST', headers:{'Content-Type':'application/json',[CSRF_HEADER]:CSRF_TOKEN}, body:JSON.stringify({scores:scoresArr, additionalInfo:null})});
          const data=await res.json();
          const total=data.totalScore ?? calcScore();
          const lv=toLevel(total);
          badge.className='mc-badge '+lv.color; badge.textContent=`${lv.badge} (ì´ì  ${total}/60)`;
          desc.textContent=data.interpretation ? `${data.interpretation} â€¢ ${data.recommendation||''}` : lv.desc;
          scorebar.style.width=(total/60*100)+'%'; scorebar.style.background=getComputedStyle(document.documentElement).getPropertyValue('--mc-blue-600');
          recoBox.textContent=data.recommendation || lv.reco;
          resultWrap.style.display='block';
        }catch(e){
          const total=calcScore(), lv=toLevel(total);
          badge.className='mc-badge '+lv.color; badge.textContent=`${lv.badge} (ì´ì  ${total}/60)`;
          desc.textContent=lv.desc; scorebar.style.width=(total/60*100)+'%'; recoBox.textContent=lv.reco; resultWrap.style.display='block';
        }
      }
    });
    prevBtn.addEventListener('click', ()=>{ if(step>0){ step--; renderStep(); }});
    resetBtn.addEventListener('click', ()=>{ for(const k in ans) delete ans[k]; step=0; resultWrap.style.display='none'; renderStep(); });
    saveBtn.addEventListener('click', async ()=>{
      const score=calcScore();
      try{
        const res=await fetch('/api/mental-care/save-assessment',{ method:'POST', headers:{'Content-Type':'application/json',[CSRF_HEADER]:CSRF_TOKEN}, body:JSON.stringify({ type:'CES-D', score, timestamp:new Date().toISOString() })});
        if(res.ok) alert('í‰ê°€ ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'); else alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }catch(e){ alert('ì„œë²„ í†µì‹  ì˜¤ë¥˜ë¡œ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
    });

    let map, clusterer, places, geocoder;
let myMarker = null;
let poiMarkers = [];
const $status = document.getElementById('mc-hosp-status');
const $list   = document.getElementById('mc-hosp-result');

function initKakao() {
  const container = document.getElementById('mc-map');
  // ê¸°ë³¸ ì„¼í„°(ì„œìš¸ì‹œì²­)ë¡œ ì´ˆê¸°í™” í›„ ì§€ì˜¤ë¡œì¼€ì´ì…˜ìœ¼ë¡œ ì¬ì´ë™
  const defaultCenter = new kakao.maps.LatLng(37.566826, 126.9786567);

  map = new kakao.maps.Map(container, { center: defaultCenter, level: 4 });
  clusterer = new kakao.maps.MarkerClusterer({ map, averageCenter:true, minLevel:6 });
  places = new kakao.maps.services.Places();
  geocoder = new kakao.maps.services.Geocoder();

  // ë‚´ ìœ„ì¹˜ë¡œ ì§€ë„ ì´ë™ + ì£¼ë³€ ê²€ìƒ‰
  tryLocateAndSearch();

  // ë²„íŠ¼ ë°”ì¸ë”©
  document.getElementById('mc-hosp-myBtn').addEventListener('click', tryLocateAndSearch);
  document.getElementById('mc-hosp-searchBtn').addEventListener('click', searchByAddress);
  document.getElementById('mc-hosp-addr').addEventListener('keypress', (e)=>{ if(e.key==='Enter') searchByAddress(); });
}

/* ë‚´ ìœ„ì¹˜ íŒŒì•… â†’ ì§€ë„ ì„¼í„° ì´ë™ â†’ ì£¼ë³€ ê²€ìƒ‰ */
function tryLocateAndSearch() {
  $status.textContent = 'ë‚´ ìœ„ì¹˜ í™•ì¸ ì¤‘â€¦';
  if (!navigator.geolocation) {
    $status.textContent = 'ë¸Œë¼ìš°ì €ì—ì„œ ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•Šì•„ìš”.';
    return;
  }
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const loc = new kakao.maps.LatLng(lat, lng);
      moveTo(loc);
      drawMyMarker(loc);
      searchNearby(loc); // í‚¤ì›Œë“œ: ì •ì‹ ê±´ê°•ì˜í•™ê³¼/ìƒë‹´ì„¼í„°
    },
    () => {
      $status.textContent = 'ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆì–´ìš”. ê¸°ë³¸ ìœ„ì¹˜ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.';
      // ê¸°ë³¸ ìœ„ì¹˜ì—ì„œë„ ì£¼ë³€ ê²€ìƒ‰ ì‹œë„
      const loc = map.getCenter();
      drawMyMarker(null); // ë§ˆì»¤ ì œê±°
      searchNearby(loc);
    },
    { enableHighAccuracy:true, timeout:8000 }
  );
}

/* ì£¼ì†Œë¡œ ê²€ìƒ‰: ì…ë ¥ ì£¼ì†Œ â†’ ì¢Œí‘œ ë³€í™˜ â†’ ì§€ë„ ì´ë™ â†’ ì£¼ë³€ ê²€ìƒ‰ */
function searchByAddress() {
  const addr = (document.getElementById('mc-hosp-addr').value || '').trim();
  if (!addr) { alert('ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
  $status.textContent = 'ì£¼ì†Œ ì¢Œí‘œ ë³€í™˜ ì¤‘â€¦';
  geocoder.addressSearch(addr, function(result, status) {
    if (status !== kakao.maps.services.Status.OK || !result.length) {
      $status.textContent = 'ì£¼ì†Œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
      return;
    }
    const lat = parseFloat(result[0].y);
    const lng = parseFloat(result[0].x);
    const loc = new kakao.maps.LatLng(lat, lng);
    moveTo(loc);
    drawMyMarker(null); // ì£¼ì†Œ ê²€ìƒ‰ì€ 'ë‚´ ìœ„ì¹˜' ë§ˆì»¤ ì œê±°
    searchNearby(loc);
  });
}

/* ì§€ë„ ì´ë™/ë¦¬ë ˆì´ì•„ì›ƒ */
function moveTo(latlng) {
  map.setCenter(latlng);
  // í˜¹ì‹œ ë ˆì´ì•„ì›ƒ ì´ìŠˆ ìˆì„ ë•Œ ì¬ê³„ì‚°
  setTimeout(()=> kakao.maps.event.trigger(map, 'resize'), 50);
}

/* ë‚´ ìœ„ì¹˜ ë§ˆì»¤ */
function drawMyMarker(latlng) {
  if (myMarker) { myMarker.setMap(null); myMarker = null; }
  if (!latlng) return;
  myMarker = new kakao.maps.Marker({
    position: latlng,
    zIndex: 10,
    image: new kakao.maps.MarkerImage(
      'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png',
      new kakao.maps.Size(24, 35)
    )
  });
  myMarker.setMap(map);
}

/* í‚¤ì›Œë“œ ê¸°ë°˜ ì£¼ë³€ ê²€ìƒ‰(ë³µìˆ˜ í‚¤ì›Œë“œ í•©ì¹˜ê¸°) */
function searchNearby(center) {
  $status.textContent = 'ì£¼ë³€ ì˜ë£Œê¸°ê´€ì„ ê²€ìƒ‰ ì¤‘â€¦';
  clearPoi();

  const keywords = ['ì •ì‹ ê±´ê°•ì˜í•™ê³¼', 'ì‹¬ë¦¬ìƒë‹´'];
  const all = new Map(); // id ì¤‘ë³µ ì œê±°

  let pending = keywords.length;
  keywords.forEach(q => {
    places.keywordSearch(q, (data, status) => {
      pending--;
      if (status === kakao.maps.services.Status.OK && Array.isArray(data)) {
        data.forEach(d => { all.set(d.id, d); });
      }
      if (pending === 0) {
        const list = Array.from(all.values());
        renderList(list);
        renderMarkers(list);
        if (list.length) fitBoundsTo(list);
        $status.textContent = `ê²€ìƒ‰ ì™„ë£Œ: ${list.length}ê³³`;
      }
    }, { location: center, radius: 3000, size: 15, sort: kakao.maps.services.SortBy.DISTANCE });
  });
}

/* ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ ë Œë” */
function renderList(list) {
  if (!Array.isArray(list) || list.length === 0) {
    $list.innerHTML = '<div class="mc-muted">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }
  $list.innerHTML = list.map(h => `
    <div class="mc-hosp">
      <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:8px;">
        <div class="mc-title" style="font-size:15px;">${escapeHtml(h.place_name || 'ì˜ë£Œê¸°ê´€')}</div>
        <span class="mc-badge mc-badge--blue">${h.distance ? (h.distance+'m') : ''}</span>
      </div>
      <div class="mc-muted" style="font-size:13px; margin:6px 0;">${escapeHtml(h.road_address_name || h.address_name || '-')}</div>
      <div class="mc-muted" style="display:flex; gap:12px; font-size:13px; margin-bottom:6px;">
        ${h.phone ? `<span>ğŸ“ ${escapeHtml(h.phone)}</span>` : ''}
      </div>
      <div style="display:flex; gap:8px; margin-top:10px;">
        <a class="mc-btn mc-btn--primary" style="flex:1;" href="https://map.kakao.com/link/to/${encodeURIComponent(h.place_name)},${h.y},${h.x}" target="_blank" rel="noopener">ê¸¸ì°¾ê¸°</a>
        <a class="mc-btn mc-btn--outline" style="flex:1;" href="https://place.map.kakao.com/${h.id}" target="_blank" rel="noopener">ìƒì„¸ë³´ê¸°</a>
      </div>
    </div>
  `).join('');
}

/* ë§ˆì»¤ ê·¸ë¦¬ê¸° */
function renderMarkers(list) {
  clearPoi();
  poiMarkers = list
    .filter(h => h.x && h.y)
    .map(h => {
      const marker = new kakao.maps.Marker({
        position: new kakao.maps.LatLng(h.y, h.x),
        title: h.place_name
      });
      const iw = new kakao.maps.InfoWindow({
        content: `<div style="padding:6px 10px; font-size:12px;">${escapeHtml(h.place_name)}</div>`
      });
      kakao.maps.event.addListener(marker, 'mouseover', ()=> iw.open(map, marker));
      kakao.maps.event.addListener(marker, 'mouseout', ()=> iw.close());
      return marker;
    });
  clusterer.addMarkers(poiMarkers);
}

/* POI ì •ë¦¬ */
function clearPoi() {
  if (poiMarkers.length) { clusterer.removeMarkers(poiMarkers); poiMarkers.forEach(m=>m.setMap(null)); }
  poiMarkers = [];
}

/* ê²°ê³¼ ì „ì²´ ë³´ì´ë„ë¡ Bounds */
function fitBoundsTo(list) {
  const bounds = new kakao.maps.LatLngBounds();
  list.forEach(h => { if (h.x && h.y) bounds.extend(new kakao.maps.LatLng(h.y, h.x)); });
  // ë‚´ ìœ„ì¹˜ ë§ˆì»¤ë„ í¬í•¨
  if (myMarker) bounds.extend(myMarker.getPosition());
  if (!bounds.isEmpty()) map.setBounds(bounds, 40, 40, 40, 40);
}

/* XSS ê°„ë‹¨ ë°©ì§€ */
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' }[m])); }

</script>
</body>
</html>