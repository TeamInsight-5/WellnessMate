<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>LifeCare - 심리케어</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/footer.css}">
    <link rel="stylesheet" th:href="@{/css/mental-care.css}">
    <script defer th:src="@{/js/mental-care.js}"></script>
    <script th:src="@{'//dapi.kakao.com/v2/maps/sdk.js?appkey=' + ${kakaoAppKey} + '&libraries=services,clusterer&autoload=false'}"></script>
</head>
<body>
<div th:replace="~{mainPage:: header}"></div>

<main class="mc-container">

    <!-- Hero -->
    <section class="mc-hero">
        <img src="/img/mental-hero.jpg" alt="정신건강 상담 배너" />
        <div class="mc-hero__inner">
            <div>
                <div class="mc-hero__icon">💙</div>
                <h1 class="mc-hero__title">심리케어</h1>
                <p class="mc-hero__desc">AI 상담부터 우울증 자가진단까지, 마음 건강을 위한 종합 케어</p>
            </div>
        </div>
    </section>

    <!-- Tabs (변경 없음) -->
    <section class="mc-tabs">
        <div class="mc-tablist" role="tablist" aria-label="심리케어 탭">
            <button class="mc-tab" role="tab" aria-selected="true" aria-controls="tab-chat" id="tabbtn-chat">🤖 AI 상담</button>
            <button class="mc-tab" role="tab" aria-selected="false" aria-controls="tab-cesd" id="tabbtn-cesd">🧠 CES-D 우울증 진단</button>
            <button class="mc-tab" role="tab" aria-selected="false" aria-controls="tab-emergency" id="tabbtn-emergency">⚡ 위기대응</button>
        </div>

        <!-- … (중략: 기존 채팅/진단/위기대응 섹션 그대로 유지) … -->

    </section>

    <!-- 병원 찾기: 주소 검색 + 내 위치 지도/검색 -->
    <section style="margin-top:28px;">
        <div class="mc-card">
            <div class="mc-toolbar" style="background:linear-gradient(90deg,#2563eb,#1d4ed8); color:#fff; padding:18px;">
                <div>
                    <div style="font-size:18px; font-weight:700;">정신건강 의료기관 찾기</div>
                    <div style="opacity:.9; font-size:13px;">내 위치 기준 지도와 주변 검색 · 주소로 재검색 가능</div>
                </div>
                <div class="mc-search-row">
                    <input id="mc-hosp-addr" class="mc-input" type="text" placeholder="예: 서울특별시 강남구 테헤란로 123" />
                    <button id="mc-hosp-searchBtn" class="mc-btn mc-btn--outline" style="color:#fff; border-color:#fff;">주소로 검색</button>
                    <button id="mc-hosp-myBtn" class="mc-btn mc-btn--primary">내 위치로 검색</button>
                </div>
            </div>

            <!-- 지도 -->
            <div class="mc-map" id="mc-map"></div>

            <!-- 검색 상태/결과 -->
            <div class="mc-card--p6">
                <div id="mc-hosp-status" class="mc-muted" style="margin-bottom:10px;"></div>
                <div id="mc-hosp-result" class="mc-grid" style="grid-template-columns: repeat(auto-fit,minmax(280px,1fr));"></div>
            </div>
        </div>
    </section>
</main>

<div th:replace="~{mainPage:: footer}"></div>

<script>
    // CSRF
    const CSRF_TOKEN = document.querySelector('meta[name="_csrf"]')?.getAttribute('content') || '';
    const CSRF_HEADER = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content') || 'X-CSRF-TOKEN';

    /* 탭 */
    const tabs = [
      {btn: 'tabbtn-chat', panel:'tab-chat'},
      {btn: 'tabbtn-cesd', panel:'tab-cesd'},
      {btn: 'tabbtn-emergency', panel:'tab-emergency'}
    ];
    tabs.forEach(t=>{
      const b=document.getElementById(t.btn), p=document.getElementById(t.panel);
      b.addEventListener('click', ()=>{
        document.querySelectorAll('.mc-tab').forEach(el=>el.setAttribute('aria-selected','false'));
        document.querySelectorAll('.mc-tabpanel').forEach(el=>el.classList.remove('is-active'));
        b.setAttribute('aria-selected','true'); p.classList.add('is-active');
      });
    });

    /* === 채팅 === */
    const chatList = document.getElementById('mc-chat-list');
    const chatInput = document.getElementById('mc-chat-input');
    const chatSend = document.getElementById('mc-chat-send');

    function addMsg(type, content, suggestions){
      const row = document.createElement('div');
      row.className = 'mc-chat__row';
      const bubble = document.createElement('div');
      bubble.className = 'mc-chat__bubble ' + (type==='user' ? 'mc-chat__bubble--user' : 'mc-chat__bubble--bot');
      bubble.textContent = content;
      const time = document.createElement('div');
      time.className = 'mc-chat__time'; time.textContent = new Date().toLocaleTimeString();
      bubble.appendChild(document.createElement('br'));
      bubble.appendChild(time);
      row.appendChild(bubble);
      chatList.appendChild(row);

      if(Array.isArray(suggestions) && suggestions.length){
        const sugg = document.createElement('div');
        sugg.className = 'mc-chat__suggest';
        suggestions.forEach(s=>{
          const btn = document.createElement('button');
          btn.className = 'mc-btn mc-btn--outline'; btn.textContent = s;
          btn.addEventListener('click', ()=> sendMessage(s));
          sugg.appendChild(btn);
        });
        chatList.appendChild(sugg);
      }
      chatList.scrollTop = chatList.scrollHeight;
    }

    async function sendMessage(text){
      if(!text || !text.trim()) return;
      addMsg('user', text);
      chatInput.value = '';

      // typing...
      const typing = document.createElement('div');
      typing.className = 'mc-chat__row mc-typing'; typing.id = 'mc-typing';
      typing.innerHTML = '<i></i><i></i><i></i>';
      chatList.appendChild(typing);
      chatList.scrollTop = chatList.scrollHeight;

      try{
        const res = await fetch('/api/mental-care/ai-chat', {
          method:'POST',
          headers:{ 'Content-Type':'application/json', [CSRF_HEADER]: CSRF_TOKEN },
          body: JSON.stringify({ message: text, sessionId: 'web-'+Date.now() })
        });
        const data = await res.json();
        document.getElementById('mc-typing')?.remove();
        const content = data.response || '답변 생성에 문제가 발생했습니다.';
        let suggestions = [];
        if(/스트레스|압박/.test(text)) suggestions = ['업무가 힘들어요','인간관계가 힘들어요','돈 걱정이 많아요','건강이 걱정돼요'];
        if(/잠|수면|불면/.test(text)) suggestions = ['2-3시간밖에 못 자요','새벽에 자주 깨요','악몽을 꿔요','전문의 상담 원해요'];
        if(/우울|슬프|무기력/.test(text)) suggestions = ['1-2주 정도요','한 달 넘게요','죽고 싶다는 생각이 들어요','누구에게도 말 못해요'];
        if(/불안|걱정|공황/.test(text)) suggestions = ['사람들 앞에서 말할 때','시험/발표 전에','이유 없이','응급상황 같아요'];
        addMsg('bot', content, suggestions);
      }catch(e){
        document.getElementById('mc-typing')?.remove();
        addMsg('bot', '서버와 통신 중 오류가 발생했습니다.');
      }
    }

    // 초기 환영 메시지
    addMsg('bot', '안녕하세요! 저는 LifeCare AI 심리상담사입니다. 😊\n\n현재 어떤 마음의 어려움을 겪고 계신가요? 편안하게 말씀해 주세요.', ['스트레스가 심해요','잠이 안 와요','우울한 기분이에요','불안해요']);
    chatSend.addEventListener('click', ()=> sendMessage(chatInput.value));
    chatInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter'){ sendMessage(chatInput.value); } });

    /* === CES-D === */
    const cesdQuestions=[{id:'q1',text:'평소에는 아무렇지도 않던 일들이 귀찮고 성가시게 느껴졌다',rev:false},{id:'q2',text:'먹고 싶지 않고 식욕이 없었다',rev:false},{id:'q3',text:'가족이나 친구가 도와주어도 울적한 기분을 떨쳐버릴 수 없었다',rev:false},{id:'q4',text:'다른 사람들만큼 능력이 있다고 느꼈다',rev:true},{id:'q5',text:'무슨 일을 하든 정신을 집중하기가 힘들었다',rev:false},{id:'q6',text:'우울했다',rev:false},{id:'q7',text:'하는 일마다 힘들게 느껴졌다',rev:false},{id:'q8',text:'미래에 대하여 희망적으로 느꼈다',rev:true},{id:'q9',text:'내 인생은 실패작이라는 생각이 들었다',rev:false},{id:'q10',text:'무서움을 느꼈다',rev:false},{id:'q11',text:'잠을 설쳤다 (잠을 잘 이루지 못했다)',rev:false},{id:'q12',text:'행복했다',rev:true},{id:'q13',text:'평소보다 말을 적게 했다',rev:false},{id:'q14',text:'세상에 홀로 있는 듯한 외로움을 느꼈다',rev:false},{id:'q15',text:'사람들이 나에게 차갑게 대하는 것 같았다',rev:false},{id:'q16',text:'생활이 즐거웠다',rev:true},{id:'q17',text:'갑자기 울음이 나왔다',rev:false},{id:'q18',text:'슬픔을 느꼈다',rev:false},{id:'q19',text:'사람들이 나를 싫어하는 것 같다고 느꼈다',rev:false},{id:'q20',text:'도무지 뭘 해나갈 엄두가 나지 않았다',rev:false}];
    const cesdOpts=[{v:0,label:'극히 드물게 (1일 미만)',desc:'전혀 없었다'},{v:1,label:'가끔 (1-2일)',desc:'조금 있었다'},{v:2,label:'종종 (3-4일)',desc:'자주 있었다'},{v:3,label:'대부분 (5-7일)',desc:'거의 매일'}];
    const ans={}; let step=0;
    const qBox=document.getElementById('mc-cesd-question-box');
    const optBox=document.getElementById('mc-cesd-options');
    const stepLabel=document.getElementById('mc-cesd-step-label');
    const prog=document.getElementById('mc-cesd-progress');
    const prevBtn=document.getElementById('mc-cesd-prev');
    const nextBtn=document.getElementById('mc-cesd-next');
    const resultWrap=document.getElementById('mc-cesd-result');
    const badge=document.getElementById('mc-cesd-badge');
    const desc=document.getElementById('mc-cesd-desc');
    const scorebar=document.getElementById('mc-cesd-scorebar');
    const recoBox=document.getElementById('mc-cesd-reco');
    const resetBtn=document.getElementById('mc-cesd-reset');
    const saveBtn=document.getElementById('mc-cesd-save');

    function renderStep(){
      const q=cesdQuestions[step];
      stepLabel.textContent=(step+1)+'/'+cesdQuestions.length;
      prog.style.width=((step+1)/cesdQuestions.length*100)+'%';
      qBox.innerHTML='<div class="mc-muted" style="font-size:13px; margin-bottom:6px;">문항 '+(step+1)+'</div><div style="font-size:16px; color:var(--mc-text);">'+q.text+'</div>';
      optBox.innerHTML='';
      cesdOpts.forEach(o=>{
        const row=document.createElement('label'); row.className='mc-radio-row';
        row.innerHTML=`<input type="radio" name="mc-ans" value="${o.v}" ${ans[q.id]===o.v?'checked':''} />
          <div><div style="font-weight:600; color:#111827;">${o.label}</div>
          <div class="mc-muted" style="font-size:12px;">${o.desc}</div></div>`;
        row.querySelector('input').addEventListener('change',e=>{ ans[q.id]=parseInt(e.target.value,10); });
        optBox.appendChild(row);
      });
      prevBtn.disabled=(step===0);
      nextBtn.textContent=(step===cesdQuestions.length-1)?'결과 보기':'다음';
    }
    renderStep();

    function calcScore(){ let total=0; cesdQuestions.forEach(q=>{ const v=ans[q.id]; if(v!==undefined){ total+=q.rev?(3-v):v; } }); return total; }
    function toLevel(score){
      if(score<16) return {badge:'정상', color:'mc-badge--green', desc:'현재 우울 증상이 거의 없는 정상 범위입니다.', reco:'규칙적인 수면/운동, 스트레스 관리로 현재 상태를 유지하세요.'};
      if(score<21) return {badge:'경미한 우울', color:'mc-badge--yellow', desc:'경미한 우울 증상이 있습니다.', reco:'생활습관 개선과 스트레스 관리, 필요 시 상담을 권장합니다.'};
      if(score<25) return {badge:'중등도 우울', color:'mc-badge--orange', desc:'중등도의 우울 증상이 나타납니다.', reco:'전문의 상담을 권장합니다.'};
      return {badge:'심한 우울', color:'mc-badge--red', desc:'심한 우울 증상으로 즉시 전문 치료가 필요합니다.', reco:'지체 없이 정신건강의학과 진료를 받으세요.'};
    }

    nextBtn.addEventListener('click', async ()=>{
      const q=cesdQuestions[step];
      if(ans[q.id]===undefined){ alert('응답을 선택해 주세요.'); return; }
      if(step<cesdQuestions.length-1){ step++; renderStep(); }
      else{
        const scoresArr=cesdQuestions.map(q=> ans[q.id] ?? 0);
        try{
          const res=await fetch('/api/mental-care/cesd-assessment',{ method:'POST', headers:{'Content-Type':'application/json',[CSRF_HEADER]:CSRF_TOKEN}, body:JSON.stringify({scores:scoresArr, additionalInfo:null})});
          const data=await res.json();
          const total=data.totalScore ?? calcScore();
          const lv=toLevel(total);
          badge.className='mc-badge '+lv.color; badge.textContent=`${lv.badge} (총점 ${total}/60)`;
          desc.textContent=data.interpretation ? `${data.interpretation} • ${data.recommendation||''}` : lv.desc;
          scorebar.style.width=(total/60*100)+'%'; scorebar.style.background=getComputedStyle(document.documentElement).getPropertyValue('--mc-blue-600');
          recoBox.textContent=data.recommendation || lv.reco;
          resultWrap.style.display='block';
        }catch(e){
          const total=calcScore(), lv=toLevel(total);
          badge.className='mc-badge '+lv.color; badge.textContent=`${lv.badge} (총점 ${total}/60)`;
          desc.textContent=lv.desc; scorebar.style.width=(total/60*100)+'%'; recoBox.textContent=lv.reco; resultWrap.style.display='block';
        }
      }
    });
    prevBtn.addEventListener('click', ()=>{ if(step>0){ step--; renderStep(); }});
    resetBtn.addEventListener('click', ()=>{ for(const k in ans) delete ans[k]; step=0; resultWrap.style.display='none'; renderStep(); });
    saveBtn.addEventListener('click', async ()=>{
      const score=calcScore();
      try{
        const res=await fetch('/api/mental-care/save-assessment',{ method:'POST', headers:{'Content-Type':'application/json',[CSRF_HEADER]:CSRF_TOKEN}, body:JSON.stringify({ type:'CES-D', score, timestamp:new Date().toISOString() })});
        if(res.ok) alert('평가 결과가 저장되었습니다.'); else alert('저장에 실패했습니다.');
      }catch(e){ alert('서버 통신 오류로 저장에 실패했습니다.'); }
    });

    let map, clusterer, places, geocoder;
let myMarker = null;
let poiMarkers = [];
const $status = document.getElementById('mc-hosp-status');
const $list   = document.getElementById('mc-hosp-result');

function initKakao() {
  const container = document.getElementById('mc-map');
  // 기본 센터(서울시청)로 초기화 후 지오로케이션으로 재이동
  const defaultCenter = new kakao.maps.LatLng(37.566826, 126.9786567);

  map = new kakao.maps.Map(container, { center: defaultCenter, level: 4 });
  clusterer = new kakao.maps.MarkerClusterer({ map, averageCenter:true, minLevel:6 });
  places = new kakao.maps.services.Places();
  geocoder = new kakao.maps.services.Geocoder();

  // 내 위치로 지도 이동 + 주변 검색
  tryLocateAndSearch();

  // 버튼 바인딩
  document.getElementById('mc-hosp-myBtn').addEventListener('click', tryLocateAndSearch);
  document.getElementById('mc-hosp-searchBtn').addEventListener('click', searchByAddress);
  document.getElementById('mc-hosp-addr').addEventListener('keypress', (e)=>{ if(e.key==='Enter') searchByAddress(); });
}

/* 내 위치 파악 → 지도 센터 이동 → 주변 검색 */
function tryLocateAndSearch() {
  $status.textContent = '내 위치 확인 중…';
  if (!navigator.geolocation) {
    $status.textContent = '브라우저에서 위치 정보를 지원하지 않아요.';
    return;
  }
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const loc = new kakao.maps.LatLng(lat, lng);
      moveTo(loc);
      drawMyMarker(loc);
      searchNearby(loc); // 키워드: 정신건강의학과/상담센터
    },
    () => {
      $status.textContent = '위치를 가져오지 못했어요. 기본 위치로 표시합니다.';
      // 기본 위치에서도 주변 검색 시도
      const loc = map.getCenter();
      drawMyMarker(null); // 마커 제거
      searchNearby(loc);
    },
    { enableHighAccuracy:true, timeout:8000 }
  );
}

/* 주소로 검색: 입력 주소 → 좌표 변환 → 지도 이동 → 주변 검색 */
function searchByAddress() {
  const addr = (document.getElementById('mc-hosp-addr').value || '').trim();
  if (!addr) { alert('주소를 입력해주세요.'); return; }
  $status.textContent = '주소 좌표 변환 중…';
  geocoder.addressSearch(addr, function(result, status) {
    if (status !== kakao.maps.services.Status.OK || !result.length) {
      $status.textContent = '주소를 찾지 못했습니다.';
      return;
    }
    const lat = parseFloat(result[0].y);
    const lng = parseFloat(result[0].x);
    const loc = new kakao.maps.LatLng(lat, lng);
    moveTo(loc);
    drawMyMarker(null); // 주소 검색은 '내 위치' 마커 제거
    searchNearby(loc);
  });
}

/* 지도 이동/리레이아웃 */
function moveTo(latlng) {
  map.setCenter(latlng);
  // 혹시 레이아웃 이슈 있을 때 재계산
  setTimeout(()=> kakao.maps.event.trigger(map, 'resize'), 50);
}

/* 내 위치 마커 */
function drawMyMarker(latlng) {
  if (myMarker) { myMarker.setMap(null); myMarker = null; }
  if (!latlng) return;
  myMarker = new kakao.maps.Marker({
    position: latlng,
    zIndex: 10,
    image: new kakao.maps.MarkerImage(
      'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png',
      new kakao.maps.Size(24, 35)
    )
  });
  myMarker.setMap(map);
}

/* 키워드 기반 주변 검색(복수 키워드 합치기) */
function searchNearby(center) {
  $status.textContent = '주변 의료기관을 검색 중…';
  clearPoi();

  const keywords = ['정신건강의학과', '심리상담'];
  const all = new Map(); // id 중복 제거

  let pending = keywords.length;
  keywords.forEach(q => {
    places.keywordSearch(q, (data, status) => {
      pending--;
      if (status === kakao.maps.services.Status.OK && Array.isArray(data)) {
        data.forEach(d => { all.set(d.id, d); });
      }
      if (pending === 0) {
        const list = Array.from(all.values());
        renderList(list);
        renderMarkers(list);
        if (list.length) fitBoundsTo(list);
        $status.textContent = `검색 완료: ${list.length}곳`;
      }
    }, { location: center, radius: 3000, size: 15, sort: kakao.maps.services.SortBy.DISTANCE });
  });
}

/* 결과 리스트 렌더 */
function renderList(list) {
  if (!Array.isArray(list) || list.length === 0) {
    $list.innerHTML = '<div class="mc-muted">검색 결과가 없습니다.</div>';
    return;
  }
  $list.innerHTML = list.map(h => `
    <div class="mc-hosp">
      <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:8px;">
        <div class="mc-title" style="font-size:15px;">${escapeHtml(h.place_name || '의료기관')}</div>
        <span class="mc-badge mc-badge--blue">${h.distance ? (h.distance+'m') : ''}</span>
      </div>
      <div class="mc-muted" style="font-size:13px; margin:6px 0;">${escapeHtml(h.road_address_name || h.address_name || '-')}</div>
      <div class="mc-muted" style="display:flex; gap:12px; font-size:13px; margin-bottom:6px;">
        ${h.phone ? `<span>📞 ${escapeHtml(h.phone)}</span>` : ''}
      </div>
      <div style="display:flex; gap:8px; margin-top:10px;">
        <a class="mc-btn mc-btn--primary" style="flex:1;" href="https://map.kakao.com/link/to/${encodeURIComponent(h.place_name)},${h.y},${h.x}" target="_blank" rel="noopener">길찾기</a>
        <a class="mc-btn mc-btn--outline" style="flex:1;" href="https://place.map.kakao.com/${h.id}" target="_blank" rel="noopener">상세보기</a>
      </div>
    </div>
  `).join('');
}

/* 마커 그리기 */
function renderMarkers(list) {
  clearPoi();
  poiMarkers = list
    .filter(h => h.x && h.y)
    .map(h => {
      const marker = new kakao.maps.Marker({
        position: new kakao.maps.LatLng(h.y, h.x),
        title: h.place_name
      });
      const iw = new kakao.maps.InfoWindow({
        content: `<div style="padding:6px 10px; font-size:12px;">${escapeHtml(h.place_name)}</div>`
      });
      kakao.maps.event.addListener(marker, 'mouseover', ()=> iw.open(map, marker));
      kakao.maps.event.addListener(marker, 'mouseout', ()=> iw.close());
      return marker;
    });
  clusterer.addMarkers(poiMarkers);
}

/* POI 정리 */
function clearPoi() {
  if (poiMarkers.length) { clusterer.removeMarkers(poiMarkers); poiMarkers.forEach(m=>m.setMap(null)); }
  poiMarkers = [];
}

/* 결과 전체 보이도록 Bounds */
function fitBoundsTo(list) {
  const bounds = new kakao.maps.LatLngBounds();
  list.forEach(h => { if (h.x && h.y) bounds.extend(new kakao.maps.LatLng(h.y, h.x)); });
  // 내 위치 마커도 포함
  if (myMarker) bounds.extend(myMarker.getPosition());
  if (!bounds.isEmpty()) map.setBounds(bounds, 40, 40, 40, 40);
}

/* XSS 간단 방지 */
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' }[m])); }

</script>
</body>
</html>