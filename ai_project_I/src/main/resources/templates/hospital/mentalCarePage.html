<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ì‹¬ë¦¬ì¼€ì–´</title>

    <!-- ê³µí†µ CSS -->
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <link rel="stylesheet" th:href="@{/css/footer.css}" />
    <!-- í˜ì´ì§€ ì „ìš© CSS -->
    <link rel="stylesheet" th:href="@{/css/mental-care.css}" />

    <!-- (ì„ íƒ) CSRF -->
    <meta name="_csrf" th:content="${_csrf?.token}" />
    <meta name="_csrf_header" th:content="${_csrf?.headerName}" />

    <!-- ë¡œê·¸ì¸ë˜ì–´ ìˆìœ¼ë©´ ìœ ì €ì•„ì´ë””, ì•„ë‹ˆë©´ JSì—ì„œ guest-ëœë¤ID ìƒì„± -->
    <meta name="lc-user-id" th:content="${#authentication?.name}" />

    <!-- Kakao ì§€ë„ SDK -->
    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=48475be29fda82ad232749bbb6f73ea1&libraries=services"></script>

    <!-- í˜ì´ì§€ ì „ìš© JS (ì§€ë„ê°€ ìˆìœ¼ë©´ ì—¬ê¸°ì„œ) -->
    <script defer th:src="@{/js/mental-care.js}"></script>
</head>

<body class="page--mental">
<!-- í—¤ë” í”„ë˜ê·¸ë¨¼íŠ¸ -->
<div th:replace="~{main/mainPage:: header}"></div>

<div class="main-wrapper">
    <!-- ìƒë‹¨ í—¤ë”: ì•„ì´ì½˜ ìœ„, ì¤‘ì•™ ì •ë ¬ -->
    <div class="page-header">
        <div class="header-icon" aria-hidden="true">ğŸ§ </div>
        <h1>ì‹¬ë¦¬ì¼€ì–´</h1>
        <p>AI ìƒë‹´ê³¼ í‘œì¤€í™”ëœ ìê°€ì§„ë‹¨ìœ¼ë¡œ ë§ˆìŒ ê±´ê°•ì„ ì‚´í´ë³´ì„¸ìš”</p>
    </div>

    <!-- ë³¸ë¬¸: ì¢Œ(ì„¤ë¬¸) / ìš°(ì±—ë´‡) -->
    <div class="content-container">
        <!-- ì„¤ë¬¸ -->
        <main class="survey-container">
            <div class="progress-bar-container">
                <span class="progress-text">ì§„í–‰ë¥ </span>
                <div class="progress-bar"><div class="progress" id="cesd-progress" style="width:5%;"></div></div>
                <span class="step-text" id="cesd-step-text">1/20</span>
            </div>

            <section id="cesd-box" class="survey-step">
                <h2>CES-D ìš°ìš¸ì¦ ìê°€ì§„ë‹¨</h2>

                <div id="cesd-question" class="mc-qbox"></div>
                <div id="cesd-options" class="mc-options"></div>

                <div class="button-group">
                    <button type="button" class="btn-secondary" id="cesd-prev" disabled>ì´ì „</button>
                    <button type="button" class="btn-primary" id="cesd-next">ë‹¤ìŒ</button>
                </div>

                <div id="cesd-result" class="mc-result" style="display:none;">
                    <!-- ìµœê·¼ CES-D ì¶”ì„¸ -->
                    <div class="cesd-trend-card" id="cesd-trend-card" style="display:none; margin-top:14px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px;">
                            <h4 style="margin:0;font-size:16px;">ìµœê·¼ CES-D ì¶”ì„¸</h4>
                            <button id="cesd-trend-clear" class="btn-secondary" type="button" style="padding:6px 10px;">ê¸°ë¡ ë¹„ìš°ê¸°</button>
                        </div>
                        <!-- CSS ë†’ì´ ê¸°ì¤€ìœ¼ë¡œ ë‚´ë¶€ ë²„í¼/ìŠ¤ì¼€ì¼ì„ ì„¸íŒ…í•˜ë¯€ë¡œ height ì†ì„±ì€ ìƒëµ -->
                        <canvas id="cesd-trend-canvas" style="width:100%;height:160px;display:block;border:1px solid var(--border);border-radius:8px;background:#fff;"></canvas>
                        <div id="cesd-trend-legend" class="mc-muted" style="margin-top:6px;font-size:13px;">
                            <span style="display:inline-block;width:10px;height:10px;background:#22c55e;border-radius:2px;vertical-align:middle;margin-right:6px;"></span>ì •ìƒ(0â€“15)
                            <span style="display:inline-block;width:10px;height:10px;background:#f59e0b;border-radius:2px;vertical-align:middle;margin:0 6px 0 12px;"></span>ì£¼ì˜(16â€“23)
                            <span style="display:inline-block;width:10px;height:10px;background:#ef4444;border-radius:2px;vertical-align:middle;margin:0 6px 0 12px;"></span>ê³ ìœ„í—˜(24â€“60)
                        </div>
                    </div>

                    <!-- ê²°ê³¼ ì¹´ë“œ -->
                    <div class="result-card">
                        <div class="result-header">
                            <h3 id="cesd-level-title">ê²°ê³¼</h3>
                            <span class="urgency-badge" id="cesd-badge">ì •ìƒ</span>
                        </div>
                        <div class="risk-score">
                            <p>ì´ì  (0â€“60)</p>
                            <div class="progress-bar-small">
                                <div class="progress-fill" id="cesd-scorebar" style="width:0%;"></div>
                            </div>
                            <span id="cesd-score-text">0 / 60</span>
                        </div>
                        <p id="cesd-desc" class="mc-muted"></p>
                    </div>

                    <div class="button-group">
                        <button type="button" class="btn-secondary" id="cesd-reset">ë‹¤ì‹œí•˜ê¸°</button>
                        <button type="button" class="btn-primary" id="cesd-save">ê²°ê³¼ ì €ì¥</button>
                    </div>
                </div>
            </section>
        </main>

        <!-- ì±—ë´‡ -->
        <aside class="mental-chat-container">
            <div class="mc-chat-card">
                <div class="mc-chat-card__header" style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                    <h3 class="mc-card-title" style="margin:0;">AI ì‹¬ë¦¬ìƒë‹´</h3>
                    <button id="mc-chat-clear" class="btn-ghost" type="button" title="ê¸°ë¡ ì‚­ì œ" style="border:none;background:transparent;cursor:pointer;">ğŸ—‘ï¸ ê¸°ë¡ ì‚­ì œ</button>
                </div>

                <div id="mc-chat-list" class="mc-chat__list"></div>

                <div class="mc-chat__input">
                    <input
                            id="mc-chat-input"
                            class="mc-input"
                            type="text"
                            placeholder="ì§€ê¸ˆ ë§ˆìŒ ìƒíƒœë¥¼ í¸í•˜ê²Œ ì ì–´ë³´ì„¸ìš”. ì˜ˆ) ìš”ì¦˜ ì ì´ ì˜ ì•ˆ ì™€ìš”"
                    />
                    <button id="mc-chat-send" class="btn-primary" type="button">ë³´ë‚´ê¸°</button>
                </div>
            </div>
        </aside>
    </div>

    <!-- í•˜ë‹¨: ì£¼ë³€ ë³‘ì› -->
    <div class="nearby-hospital-section">
        <div class="nearby-hospital-header">
            <h4>ì£¼ë³€ ì •ì‹ ê±´ê°•ì˜í•™ê³¼</h4>
        </div>
        <div id="map-container"></div>
        <div class="hospital-grid" id="nearby-hospitals-list"></div>
    </div>
</div>

<!-- í‘¸í„° í”„ë˜ê·¸ë¨¼íŠ¸ -->
<div th:replace="~{main/mainPage:: footer}"></div>

<!-- ì„œë²„ê°€ Thymeleafë¡œ ë‚´ë ¤ì¤„ ìˆ˜ ìˆìœ¼ë©´ ë¬¸ìì—´, ì•„ë‹ˆë©´ null -->
<script th:inline="javascript">
    window.lcUserId = /*[[${#authentication?.name}]]*/ null;
</script>

<!-- ===== ì±—ë´‡(ë¡œì»¬ ì €ì¥/ë³µì›) ===== -->
<script>
    (function () {
      if (window.__mcChatInit) return;
      window.__mcChatInit = true;

      // ì„œë²„ì—ì„œ JS ë³€ìˆ˜ ëª» ë‚´ë ¸ì„ ë•Œ ë©”íƒ€íƒœê·¸ë¡œ ë³´ì™„
      if (!window.lcUserId) {
        const metaId = document.querySelector('meta[name="lc-user-id"]')?.content;
        if (metaId && metaId.trim()) window.lcUserId = metaId.trim();
      }

      // ì‚¬ìš©ì ID ê²°ì •(ë¡œê·¸ì¸ ì•„ì´ë”” ìš°ì„ , ì—†ìœ¼ë©´ ê²ŒìŠ¤íŠ¸ ê³ ì •)
      const resolvedUserId = (function() {
        if (window.lcUserId && typeof window.lcUserId === 'string' && window.lcUserId.trim()) {
          localStorage.setItem('lc_user_id', window.lcUserId);
          return window.lcUserId;
        }
        const existing = localStorage.getItem('lc_user_id');
        if (existing) return existing;
        const guest = 'guest_' + Math.random().toString(36).slice(2, 10);
        localStorage.setItem('lc_user_id', guest);
        return guest;
      })();

      const STORAGE_KEY = `mc_chat_logs:${resolvedUserId}`;

      // DOM
      const chatList = document.getElementById("mc-chat-list");
      const input = document.getElementById("mc-chat-input");
      const sendBtn = document.getElementById("mc-chat-send");
      const clearBtn = document.getElementById("mc-chat-clear");

      // ìƒíƒœ
      let history = [];

      // ë Œë” ìœ í‹¸
      function renderBubble({ role, text }) {
        const div = document.createElement("div");
        div.className = "chat-bubble " + (role === "user" ? "user" : "bot");
        div.textContent = text;
        chatList.appendChild(div);
        chatList.scrollTop = chatList.scrollHeight;
      }

      function saveHistory() {
        if (history.length > 200) history = history.slice(-200);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
      }

      function appendAndPersist(role, text) {
        const entry = { role, text, ts: Date.now() };
        history.push(entry);
        saveHistory();
        renderBubble(entry);
      }

      function loadHistory() {
        chatList.innerHTML = "";
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
          const welcome = "ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” LifeCare AI ì‹¬ë¦¬ìƒë‹´ì‚¬ì…ë‹ˆë‹¤. ğŸ˜Š\nì§€ê¸ˆ ë§ˆìŒ ìƒíƒœë¥¼ í¸í•˜ê²Œ ì ì–´ì£¼ì„¸ìš”.";
          history = [{ role: "bot", text: welcome, ts: Date.now() }];
          saveHistory();
          renderBubble(history[0]);
          return;
        }
        try {
          history = JSON.parse(raw) || [];
          history.forEach(renderBubble);
        } catch (e) {
          console.warn("ì±„íŒ… ê¸°ë¡ íŒŒì‹± ì‹¤íŒ¨. ì´ˆê¸°í™”í•©ë‹ˆë‹¤.", e);
          localStorage.removeItem(STORAGE_KEY);
          history = [];
          loadHistory();
        }
      }

      // íƒ€ì´í•‘ í‘œì‹œ
      function showTyping() {
        const typing = document.createElement("div");
        typing.className = "chat-bubble bot typing";
        typing.innerHTML = `<span class="dot"></span><span class="dot"></span><span class="dot"></span>`;
        chatList.appendChild(typing);
        chatList.scrollTop = chatList.scrollHeight;
        return typing;
      }
      function hideTyping(el) { if (el && el.parentNode) el.remove(); }

      // ì „ì†¡
      async function sendMessage() {
        const message = input.value.trim();
        if (!message) return;

        appendAndPersist("user", message);
        input.value = "";

        const typingEl = showTyping();
        try {
          const res = await fetch("http://localhost:8000/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ user_message: message })
          });
          const data = await res.json();
          hideTyping(typingEl);

          const reply = (data && data.reply) ? String(data.reply) : "ì£„ì†¡í•©ë‹ˆë‹¤. ì‘ë‹µì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.";
          appendAndPersist("bot", reply);
        } catch (err) {
          hideTyping(typingEl);
          appendAndPersist("bot", "âš ï¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
          console.error(err);
        }
      }

      // ì´ë²¤íŠ¸(ì¤‘ë³µ ë°©ì§€ í”Œë˜ê·¸)
      if (!sendBtn.dataset.bound) {
        sendBtn.addEventListener("click", sendMessage);
        sendBtn.dataset.bound = "1";
      }
      if (!input.dataset.bound) {
        input.addEventListener("keydown", (e) => { if (e.key === "Enter") sendMessage(); });
        input.dataset.bound = "1";
      }
      if (clearBtn && !clearBtn.dataset.bound) {
        clearBtn.addEventListener("click", () => {
          if (!confirm("í˜„ì¬ ì±„íŒ… ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?")) return;
          localStorage.removeItem(STORAGE_KEY);
          history = [];
          chatList.innerHTML = "";
          loadHistory();
        });
        clearBtn.dataset.bound = "1";
      }

      // ì´ˆê¸° ë Œë”
      loadHistory();
    })();
</script>

<!-- ===== CES-D ì ìˆ˜ ì €ì¥ & ì¶”ì„¸ í‘œì‹œ(ë¡œì»¬ ë³´ê´€) ===== -->
<script>
    (function(){
      // ì‚¬ìš©ì ID í•´ì„(ë¡œê·¸ì¸ > ì €ì¥ëœ guest > ìƒˆ guest)
      function resolveUserId(){
        try {
          if (window.lcUserId && String(window.lcUserId).trim()) {
            localStorage.setItem('lc_user_id', window.lcUserId);
            return String(window.lcUserId).trim();
          }
        } catch(e){}
        const ex = localStorage.getItem('lc_user_id');
        if (ex) return ex;
        const guest = 'guest_' + Math.random().toString(36).slice(2,10);
        localStorage.setItem('lc_user_id', guest);
        return guest;
      }
      const USER_ID = resolveUserId();
      const STORAGE_KEY = `cesdScores:${USER_ID}`;   // ì‚¬ìš©ìë³„ ë¶„ë¦¬

      const $canvas    = document.getElementById('cesd-trend-canvas');
      const $card      = document.getElementById('cesd-trend-card');
      const $btnClear  = document.getElementById('cesd-trend-clear');
      const $saveBtn   = document.getElementById('cesd-save');
      const $scoreText = document.getElementById('cesd-score-text');

      // ì ìˆ˜ ëª©ë¡ ë¡œë“œ/ì„¸ì´ë¸Œ
      function loadScores(){
        try {
          const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
          return Array.isArray(arr) ? arr : [];
        } catch { return []; }
      }
      function saveScores(arr){
        localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
      }

      // ì ìˆ˜ ì €ì¥: {ts, score}
      function addScore(score){
        const list = loadScores();
        list.push({ ts: Date.now(), score: Number(score) || 0 });
        // ìµœê·¼ 12ê°œë§Œ ë³´ê´€
        const trimmed = list.slice(-12);
        saveScores(trimmed);
        return trimmed;
      }

      // ë¦¬ì‚¬ì´ì¦ˆ ëŒ€ì‘: CSS ë†’ì´ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë‚´ë¶€ ë²„í¼/ì¢Œí‘œê³„ë¥¼ ì„¸íŒ…
      function fitCanvas() {
        if (!$canvas) return;
        const scale = window.devicePixelRatio || 1;

        // CSS í¬ê¸°(ë³´ì´ëŠ” í¬ê¸°) ê°€ì ¸ì˜¤ê¸°
        const rect = $canvas.getBoundingClientRect();
        const cssH = parseFloat(getComputedStyle($canvas).height) || rect.height || 160;

        // ë‚´ë¶€ ë²„í¼ ì‚¬ì´ì¦ˆ ì„¤ì • (í”½ì…€ ë‹¨ìœ„)
        $canvas.width  = Math.max(300, Math.floor(rect.width  * scale));
        $canvas.height = Math.max(120, Math.floor(cssH       * scale));

        // ê·¸ë¦¬ê¸° ì¢Œí‘œê³„ë¥¼ CSS px ê¸°ì¤€ìœ¼ë¡œ ë§ì¶¤
        const ctx = $canvas.getContext('2d');
        ctx.setTransform(scale, 0, 0, scale, 0, 0);
      }

      // ì°¨íŠ¸ ë Œë” (ë§‰ëŒ€ê·¸ë˜í”„)
      function render() {
        if (!$canvas || !$card) return;

        const data = loadScores();
        if (!data.length) {
          $card.style.display = 'none';
          return;
        }
        $card.style.display = 'block';

        // ë¨¼ì € ì‚¬ì´ì§•
        fitCanvas();

        // ë ˆì´ì•„ì›ƒì´ ì•„ì§ ì•ˆ ì¡í˜”ë‹¤ë©´ ë‹¤ìŒ í”„ë ˆì„ì— ì¬ì‹œë„
        const rect = $canvas.getBoundingClientRect();
        if (rect.width <= 0 || rect.height <= 0) {
          requestAnimationFrame(render);
          return;
        }

        const ctx = $canvas.getContext('2d');

        // ë‚´ë¶€ ë²„í¼ëŠ” device px, ìš°ë¦¬ëŠ” CSS px ì¢Œí‘œê³„ë¡œ ê·¸ë¦¬ë¯€ë¡œ scaleë¡œ ë‚˜ëˆ ì„œ ì‚¬ìš©
        const scale = window.devicePixelRatio || 1;
        const w = $canvas.width  / scale;
        const h = $canvas.height / scale;

        // ë°°ê²½ í´ë¦¬ì–´
        ctx.clearRect(0, 0, w, h);
        ctx.fillStyle = '#f8fafc';
        ctx.fillRect(0, 0, w, h);

        // ê°€ì´ë“œë¼ì¸(0,16,24,60)
        ctx.strokeStyle = '#e5e7eb';
        ctx.lineWidth = 1;
        [0,16,24,60].forEach(v=>{
          const y = h - (v/60)*h;
          ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(w, y); ctx.stroke();
          ctx.fillStyle = '#9ca3af';
          ctx.font = '12px sans-serif';
          ctx.textAlign = 'left';
          ctx.fillText(String(v), 4, Math.min(h-2, y-2));
        });

        // ë§‰ëŒ€ ë„ˆë¹„/ê°„ê²© ê³„ì‚°
        const N = data.length;
        const margin = 12;
        const usable = Math.max(0, w - margin*2);
        const bw  = Math.max(10, Math.floor((usable / Math.max(N,1)) * 0.6)); // bar width
        const gap = Math.max(6, Math.floor((usable - bw*N) / Math.max(N-1,1))); // gap

        // ë°” ê·¸ë¦¬ê¸°
        let x = margin;
        data.forEach(d => {
          const s  = Math.max(0, Math.min(60, Number(d.score)||0));
          const bh = (s/60) * h;
          const y  = h - bh;

          let color = '#22c55e';
          if (s>=16 && s<=23) color = '#f59e0b';
          if (s>=24)          color = '#ef4444';

          ctx.fillStyle = color;
          ctx.fillRect(x, y, bw, bh);

          if (N <= 12) {
            ctx.fillStyle = '#334155';
            ctx.font = '11px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(String(s), x + bw/2, y - 4);
          }
          x += bw + gap;
        });
      }

      // ì ìˆ˜ ì €ì¥ ë²„íŠ¼
      function onSaveClick(){
        if (!$scoreText) { alert('ì ìˆ˜ ì—˜ë¦¬ë¨¼íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ìš” (#cesd-score-text).'); return; }
        const m = String($scoreText.textContent||'').match(/(\d+)\s*\/\s*60/);
        const score = m ? Number(m[1]) : NaN;
        if (!Number.isFinite(score)) {
          alert('ì ìˆ˜ë¥¼ ì½ì„ ìˆ˜ ì—†ì–´ìš”. ê²°ê³¼ê°€ ë¨¼ì € ê³„ì‚°/í‘œì‹œëœ í›„ ì €ì¥í•´ì£¼ì„¸ìš”.');
          return;
        }
        addScore(score);
        render();
        try {
          $saveBtn.disabled = true;
          $saveBtn.textContent = 'ì €ì¥ë¨';
          setTimeout(()=>{ $saveBtn.disabled=false; $saveBtn.textContent='ê²°ê³¼ ì €ì¥'; }, 1200);
        } catch {}
        if ($card) $card.style.display = 'block';
      }

      // ê¸°ë¡ ë¹„ìš°ê¸° ë²„íŠ¼
      function onClearClick(){
        if (!confirm('ì €ì¥ëœ CES-D ê¸°ë¡ì„ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?')) return;
        saveScores([]);
        render();
      }

      // ì´ˆê¸° ë Œë” + ì´ë²¤íŠ¸
      window.addEventListener('resize', render);
      if ($btnClear) $btnClear.addEventListener('click', onClearClick);
      if ($saveBtn)  $saveBtn.addEventListener('click', onSaveClick);

      // í˜ì´ì§€ ì§„ì… ì‹œ ê¸°ì¡´ ê¸°ë¡ í‘œì‹œ
      render();

      // ì™¸ë¶€ì—ì„œ ì§ì ‘ ì €ì¥í•˜ê³  ì‹¶ì„ ë•Œ ì‚¬ìš© ê°€ëŠ¥ (ì˜µì…˜)
      window.CesdTrend = {
        save: function(score){ addScore(score); render(); },
        render
      };
    })();
</script>
</body>
</html>
